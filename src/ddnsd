#!/usr/bin/env bash

# Copyright (C) 2025 Michael Schaecher <michaelschaecher@mlstidbits.com>
# Copyright (C) 2025 MLS Tidbits <contact@mlstidbits.com>

# This program is free software: you can redistribute it and/or modify.

# Check if the script is run as root
function root-check () { (( "$(id -u)" == 0 )) || event-log "error" "This script must be run as root." ; }

# shellcheck disable=SC2329
function sign_handler () {

    local signalHandler="${1:-SIGINT}"

    case "$signalHandler" in
        SIGINT|SIGTERM|SIGQUIT ) event-log "info" "Received $signalHandler. Exiting gracefully..." ;;
        *                      ) event-log "warning" "Received unknown signal: $signalHandler"     ;;
    esac

    exit 0

}

# shellcheck disable=SC2155
function event-log () {

    local _event="${1:-info}"
    local _message="${2:-No message provided}"

    case "$_event" in
        info|warning   ) logger -t "${appName}" -p user."$_event" "$_message"        ;;
        error|critical ) logger -t "$appName" -p user."$_event" "$_message" ; exit 1 ;;
        *              ) logger -t "$appName" -p user.unknown "$_message"            ;;
    esac

}

# shellcheck disable=SC2155
function monitor-ip-address () {

    root-check

    [[ "$domainName" == "Null" ]] && event-log "error" "Domain Name is required, see $appConfig"

    [[ "$apiToken" == "Null" ]] && event-log "error" "Missing API Token for Cloudflare!"

    while true ; do

        local currentIP="$(check-ip)"

        [[ "$currentIP" == "" ]] &&
        event-log "warning" "Failed to retrieve current IP address from $ipLookup service"

        local savedIP="$(current-ip)"

        [[ "$savedIP" == "$currentIP" ]] &&
        event-log "info" "No IP address change detected. Current IP: ${currentIP}"

        if [[ "${savedIP}" != "${currentIP}" && -n $currentIP ]] ; then

            event-log "info" "IP address changed: ${savedIP} -> ${currentIP}"

            case "${ddnsProvider}" in
                "duck"       ) duck-ddns                                                   ;;
                "cloudflare" ) cloudflare-ddns                                             ;;
                *            ) event-log "error" "Unsupported DDNS provider: ${ddnsProvider}" ;;
            esac

            event-log "info" "DDNS update completed for ${domainName} with IP ${currentIP}"
        fi

        sleep 5m ; continue
    done
}

# shellcheck disable=SC2155
function stop-ddnsd () {

    root-check
    echo "Stopping ddnsd service..."

    systemctl stop ddnsd.service || event-log "warning" "ddnsd service is not running."

    # Stop the ddnsd service and all instances of ddnsd
    pkill -f ddnsd || echo "No ddnsd process found to stop."

    rm -f "$currentIP" || event-log "error" "Failed to remove IP address file ${currentIP}."

    event-log "info" "ddnsd service stopped."

}

# shellcheck disable=SC2155
function duck-ddns () {

    local useHTTPS

    event-log "info" "Configuring DuckDNS for domain $domainName..."

    local duckURL="https://www.duckdns.org/update?domains=${domainName}&token=$apiToken&ip="

    [[ "$verboseOutput" == "" || "$verboseOutput" == "Null" ]] &&
    event-log "error" "Verbose setting is required for DuckDNS, see $appConfig"

    [[ "$useInsecure" == "true" ]] && { event-log "warning" "DuckDDNS Insecure mode enabled" ; useHTTPS="-kk" ; }
    [[ "$useInsecure" == "false" ]] && useHTTPS="-k"

    ddnsResponse="$(curl -s "url=${duckURL}&${verboseOutput}" | grep -oE 'OK|KO')"

    [[ "$ddnsResponse" == "OK" ]] && event-log "info" "DuckDNS update successful."
    [[ "$ddnsResponse" == "KO" ]] && event-log "error" "DuckDNS update failed."

    [[ "$ddnsResponse" != "OK" && "$ddnsResponse" != "KO" ]] &&
    event-log "error" "Unexpected response from DuckDNS: ${ddnsResponse}"

}

# shellcheck disable=SC2155
function cloudflare-ddns () {

    event-log "info" "Configuring Cloudflare for domain $domainName"

    # Verify that the Cloudflare email set and is in the correct format
    [[ "$emailAddress" != "" && "$emailAddress" != "Null" ]] ||
    event-log "error" "Cloudflare email is required, see $appConfig"

    [[ ! "$emailAddress" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]] &&
    event-log "error" "$emailAddress Invalid email format for Cloudflare, see $appConfig"

    # Verify that the Cloudflare Zone ID is set
    [[ "$apiZone" != "" && "$apiZone" != "Null" ]] ||
    event-log "error" "Cloudflare Zone ID is required, see $appConfig"

    local tokenURL="https://api.cloudflare.com/client/v4/user/tokens/verify"
    local apiZoneURL="https://api.cloudflare.com/client/v4/zones"


    # Check if method is either token or global
    case "$methodType" in
        "token"  ) _header="Authorization: Bearer" ;;
        "global" ) _header="X-Auth-Key"            ;;
        *        ) event-log "error" "Unsupported Cloudflare authentication method: $methodType"
        ;;
    esac

    local verifyToken="$(curl -X GET "$tokenURL" \
        --header "$_header $apiToken" \
        --header "Content-Type:  application/json" |
        jq -r '.result.status')"

    [[ "$verifyToken" != "active" ]] && event-log "error" "Cloudflare API token verification failed."

    event-log "info" "Verified Cloudflare API token = ${verifyToken}"

    local dnsRecords=$(curl -s -X GET "$apiZoneURL/$apiZone/dnsdnsRecordss" \
        --header "X-Auth-Email: $emailAddress" \
        --header "$_header $apiToken" \
        --header "Content-Type: application/json" |
         jq -r '.result[] | .id')

    [[ -z "$dnsRecords" ]] && event-log "error" "No DNS record found for $domainName in zone $apiZone"

    event-log "info" "Found DNS record for $domainName in zone $apiZone"

    local currentIP="$(check-ip)"

    local updateDNS="$(curl -sS -X PUT "$apiZoneURL/$apiZone/dnsdnsRecordss/$dnsRecords" \
        --header "X-Auth-Email: $emailAddress" \
        --header "$_header $apiToken" \
        --header "Content-Type: application/json" \
        --data "{
            \"type\": \"A\",
            \"name\": \"${domainName}\",
            \"content\": \"$currentIP\",
            \"ttl\": $timeToLive,
            \"proxied\": $useProxy
        }" | jq -r '.success')"

        test "$updateDNS" = "true" || event-log "error" "cLOUDFLARE DNS record update failed."

    event-log "info" "Cloudflare DNS record updated successfully."

}

function check-ip () {

    local lookupService

    case "$ipLookup" in
        "icanhazip" ) lookupService="$ipLookup.com"   ;;
        "ipinfo"    ) lookupService="$ipLookup.io/ip" ;;
        "ifconfig"  ) lookupService="$ipLookup.co"    ;;
        *           )
            event-log "error" "Unsupported IP lookup service: $ipLookup"
        ;;
    esac

    curl -s "https://$lookupService"
}

function ddnsd-conf () {

    # Check if the user is root or has permission to edit the configuration file.
    # if check fails then rerun the script with sudo.
    root-check

    if $defaultEditor "$appConfig" ; then
        event-log "info" "Configuration file $appConfig edited successfully."
    else
        echo "Failed to open configuration file in ${defaultEditor}."
        event-log "error" "Failed to open configuration file in ${defaultEditor}."
    fi

}

function current-ip () { ping -c 1 "$domainName" | awk 'NR==2 {print $5}' | tr -d '():' ; }

function restart-ddnsd () { root-check ; systemctl restart ddnsd.service ; }

# Uncomment for debugging
#set -euox pipefail

appName="ddnsd"
appVersion="$(cat /usr/share/doc/${appName}/version 2>/dev/null || echo "unknown")"
defaultEditor="${EDITOR:-nano}"

appConfig="/etc/${appName}/config"

[[ ! -f "$appConfig" ]] &&
event-log "error" "Configuration file $appConfig not found. Please create it."

source "$appConfig" 2> /dev/null ||
event-log "error" "Failed to source configuration file $appConfig."

# shellcheck disable=SC1090
source "$appConfig"

### Global Configuration Variables ###

ipLookup="${LOOKUP:-icanhazip}"
ddnsProvider="${PROVIDER:-duckdns}"
domainName="${DOMAIN:-Null}"
apiToken="${TOKEN:-Null}"

### Cloudflare Specific Configuration Variables ###

emailAddress="${EMAIL:-Null}"
methodType="${METHOD:-token}"
apiZone="${ZONE:-Null}"
useProxy="${PROXY:-false}"
timeToLive="${TTL:-300}"

### DuckDNS Specific Configuration Variables ###

useInsecure="${INSECURE:-false}"
verboseOutput="${VERBOSE:-false}"

# Trap errors and log them
trap sign_handler SIGINT SIGTERM SIGQUIT

versionInfo="$(cat <<EOF
${appName} - [ Version: ${appVersion} ] - License: GPLv3.0"
EOF
)"

helpInfo="$(cat <<EOF
${versionInfo}

Usage: ${appName} [start|stop|restart|status|config|help|version]

Options:
    start           Start monitoring for IP changes and update DDNS
    stop            Stop the ddnsd systemd service
    restart         Restart the ddnsd systemd service
    status          Show the status of the ddnsd service
    config          Show the current configuration (use 'config <provider>' to edit)
    help            Show this help message
    version         Show version information

Version: ${appVersion}
EOF
)"

[[ "$(check-ip)" != "$(current-ip)" ]] && currentIP="$(current-ip) OUTDATED"
[[ "$(check-ip)" == "$(current-ip)" ]] && currentIP="$(current-ip) CURRENT"

statusInfo="$(cat <<EOF
${versionInfo}

DDNS Provider:          $ddnsProvider
Domain Name:            $domainName
Token Set:              $apiToken
IP Address:             $currentIP

Service:                $(systemctl is-active --quiet ddnsd.service &&
echo "active" || echo "inactive")
DDNS Status:            $(ping -c 1 "$domainName" &> /dev/null &&
echo "reachable" || echo "unreachable")

Lookup Service:         $ipLookup
EOF
)"

# shellcheck disable=SC2154
case "${1}" in
    start   ) monitor-ip-address                                                            ;;
    stop    ) stop-ddnsd                                                                    ;;
    restart ) restart-ddnsd                                                                 ;;
    status  ) echo "$statusInfo"                                                            ;;
    config  ) ddnsd-conf "$@"                                                               ;;
    help    ) echo "$helpInfo"                                                              ;;
    version ) echo "$versionInfo"                                                           ;;
    *       ) event-log "info" "Invalid option: ${1:-none}" ; event-log "error" "$helpInfo" ;;
esac

exit 0
